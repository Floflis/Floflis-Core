#!/bin/bash

if cat /proc/1/cgroup | tail -1 | grep -q "container"; then
  echo "linux container. Floflis' firstboot won't run."
else
  full_fs=$(df ~ | tail -1 | awk '{print $1;}')  # /dev/sda1
  fs=$(basename $full_fs)                        # sda1
  if grep -q "$fs" /proc/partitions; then
    echo "regular linux install. Floflis' firstboot will proceed."
    FLAG="/var/log/firstboot.log"
    if [ ! -f $FLAG ]
       then
          #Put here your initialization cmds
          echo "This is the first boot."
          cd /home
          for D in `find . -mindepth 1 -maxdepth 1 -type d`
          do
             cd ${D}
             cat > firstlogon.sh << ENDOFFILE
#!/bin/bash
cat << "EOF" 
-. .-.   .-. .-.   .-. .-.   .
  \   \ /   \   \ /   \   \ /
 / \   \   / \   \   / \   \
~   `-~ `-`   `-~ `-`   `-~ `-
  _            _           
 |_  |   _   _|_  |  o   _ 
 |   |  (_)   |   |  |  _> 
                           
  ___               _            _   _             
 |_ _|  _ _    ___ | |_   __ _  | | | |  ___   _ _ 
  | |  | ' \  (_-< |  _| / _` | | | | | / -_) | '_|
 |___| |_||_| /__/  \__| \__,_| |_| |_| \___| |_|  

                  Welcome to Floflis!
EOF
# Core>
   if [ -e /usr/lib/floflis/layers/dna/floflis ]
   then
      if [ -e /usr/lib/floflis/layers/dna/layers/core ]
      then
                  echo "Getting and storing username..."
         flouser=$(echo ~ | awk -F/ '{print $NF}')
         $maysudo cat > /1/config/dat.json << "EOF"
       {"type":"config/os","url":{},"lang":"en-us","title":"Floflis Settings - ${flouser}","user":" ${flouser}"}
EOF
         $maysudo sed -i 's/user="blank"/user="${flouser}"/g' /usr/lib/floflis/config
fi
fi
# <Core

cat > ~/.config/autostart/IPFS.desktop << "EOF"
[Desktop Entry]
Encoding=UTF-8
Version=0.9.4
Type=Application
Name=IPFS
Comment=
Exec=ipfsdaemon
Icon=ipfs
StartupNotify=true
Terminal=false
Hidden=false

EOF
$maysudo chmod -R a+rwX ~/.config/autostart/IPFS.desktop

echo "- Initializing IPFS..."
ipfs init
echo "- To start IPFS service, open a new term window and type 'ipfs daemon', or restart your computer after Floflis is fully installed."

# Install SSH:

if [ ! -e /usr/lib/floflis/layers/dna/layers/server ]
then
   echo "Don't install SSH if don't know how bad systemd is or if you think BIOS is a fossil fuel. And never use SSH to remotely access your devices in a public network, such as mobile. SSH can be useful for securer (than HTTP) downloads. Estimated 1MB to download/6 MB installed."
   echo "Do you want to install SSH? [Y/n]"
   read instssh
   case $instssh in
      [nN])
         echo "${ok}"
         break ;;
      [yY])
         echo "Installing SSH..."
         $maysudo apt-get install ssh -y
         break ;;
      *)
         echo "${invalid}" ;;
esac
fi

rm -rf firstlogon.sh
rm -rf ${flouser}/.config/autostart/firstlogon.desktop
echo "(âœ“) Floflis has been successfully installed! You can now use it :)"

ENDOFFILE
             mkdir .config
             mkdir .config/autostart
             cd .config/autostart
             cat > firstlogon.desktop << ENDOFFILE
[Desktop Entry]
Version=1.0
Name=FirstLogon
Comment=
Exec=gnome-terminal --tab --title="Welcome to Floflis!" -- "sh ./firstlogon.sh"
Encoding=UTF-8
Type=Application
Categories=Application;
Icon=utilities-terminal
StartupNotify=true
Terminal=true
Hidden=false

ENDOFFILE
             $maysudo chmod -R a+rwX firstlogon.desktop
done
          cd
          #the next line creates an empty file so it won't run the next boot
          touch $FLAG
       else
          echo "No need to run Floflis' first boot script."
          #task: remove this script from init.d
fi
  else
    echo "live OS running from RAM. Floflis' firstboot won't run."
  fi
fi
